<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion des Cotisations - APEE CES D'EKALI 1</title>
    <link rel="stylesheet" href="style.css">
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#4CAF50">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="APEE EKALI1">
    
<link rel="apple-touch-icon" sizes="57x57" href="icons/apple-icon-57x57.png">
<link rel="apple-touch-icon" sizes="60x60" href="icons/apple-icon-60x60.png">
<link rel="apple-touch-icon" sizes="72x72" href="icons/apple-icon-72x72.png">
<link rel="apple-touch-icon" sizes="76x76" href="icons/apple-icon-76x76.png">
<link rel="apple-touch-icon" sizes="114x114" href="icons/apple-icon-114x114.png">
<link rel="apple-touch-icon" sizes="120x120" href="icons/apple-icon-120x120.png">
<link rel="apple-touch-icon" sizes="144x144" href="icons/apple-icon-144x144.png">
<link rel="apple-touch-icon" sizes="152x152" href="icons/apple-icon-152x152.png">
<link rel="apple-touch-icon" sizes="180x180" href="icons/apple-icon-180x180.png">
<link rel="icon" type="image/png" sizes="192x192"  href="icons/android-icon-192x192.png">
<link rel="icon" type="image/png" sizes="32x32" href="icons/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="96x96" href="icons/favicon-96x96.png">
<link rel="icon" type="image/png" sizes="16x16" href="icons/favicon-16x16.png">

<meta name="msapplication-TileColor" content="#ffffff">
<meta name="msapplication-TileImage" content="icons/ms-icon-144x144.png">
<meta name="theme-color" content="#ffffff">
    
    <!-- Manifest -->
    <link rel="manifest" href="manifest.json">
</head>
<body>
    <div class="container">
        <header class="no-print">
            <h1>APEE DU CES D'EKALI 1</h1>
            <h2>GESTION DES COTISATIONS DES PARENTS</h2>
            <div class="semaine">
                <div>Semaine du: <input type="date" id="date-debut"></div>
                <div>au: <input type="date" id="date-fin"></div>
            </div>
            
            <!-- Indicateur de statut PWA -->
            <div id="pwa-status" class="pwa-status" style="display: none;">
                <span id="pwa-message"></span>
                <button id="install-button" class="pwa-button" style="display: none;">Installer l'application</button>
            </div>
        </header>

        <div class="tabs no-print">
            <button class="tab-button active" onclick="showTab('paiement')">Paiement des Cotisations</button>
            <button class="tab-button" onclick="showTab('budget')">Impact sur le Budget</button>
            <button class="tab-button" onclick="showTab('historique')">Historique des Paiements</button>
        </div>

        <!-- Onglet Paiement des Cotisations -->
        <div id="paiement" class="tab-content active">
            <!-- Section pour la gestion des fichiers -->
            <div class="file-management no-print">
                <h2>Gestion des Fichiers de Donn√©es</h2>
                <p>Exportez vos donn√©es pour les sauvegarder ou les importer sur un autre appareil.</p>
                
                <div class="file-buttons">
                    <button class="file-button" onclick="exporterPaiements()">üì• Exporter les paiements</button>
                    <button class="file-button import" onclick="importerPaiements()">üì§ Importer des paiements</button>
                    <button class="file-button backup" onclick="sauvegarderBackup()">üíæ Sauvegarder Backup Complet</button>
                    
                    <input type="file" id="file-input" accept=".json">
                </div>
                
                <div class="file-info">
                    <p><strong>Instructions :</strong></p>
                    <ul>
                        <li>Exportez les paiements pour sauvegarder les donn√©es actuelles</li>
                        <li>Importez des paiements pour restaurer une sauvegarde</li>
                        <li>Les fichiers sont sauvegard√©s au format JSON dans votre dossier de t√©l√©chargements</li>
                    </ul>
                </div>
            </div>

            <div class="card no-print">
                <h2>Informations du Parent/Tuteur</h2>
                
                <div id="info-parent" class="parent-info">
                    <strong>Statut: </strong><span id="statut-parent"></span>
                    <div id="details-parent"></div>
                </div>
                
                <div id="paiement-dette" class="paiement-dette">
                    <strong>‚ö† Paiement de dette seulement</strong>
                    <p>Le parent existant n'a pas ajout√© de nouvel √©l√®ve. Le montant √† payer correspond au solde pr√©c√©dent.</p>
                </div>
                
                <div class="form-group">
                    <label for="nom-parent">Nom complet du parent/tuteur *</label>
                    <input type="text" id="nom-parent" required placeholder="Nom et pr√©nom" onblur="verifierParent()">
                </div>
                
                <div class="form-group">
                    <label for="telephone">Num√©ro de t√©l√©phone *</label>
                    <input type="tel" id="telephone" required placeholder="Pour l'envoi de SMS" onblur="verifierParent()">
                </div>
                
                <div class="form-group">
                    <label for="adresse">Adresse compl√®te</label>
                    <textarea id="adresse" rows="2" placeholder="Adresse postale"></textarea>
                </div>
                
                <div class="montant-info">
                    Cotisation par √©l√®ve: 12 500 FCFA
                </div>
            </div>

            <div class="card no-print">
                <h2>Ajouter un √©l√®ve</h2>
                <div class="form-group">
                    <label for="nom-eleve">Nom de l'√©l√®ve *</label>
                    <input type="text" id="nom-eleve" placeholder="Nom et pr√©nom">
                </div>
                
                <div class="form-group">
                    <label for="classe">Classe de l'√©l√®ve *</label>
                    <input type="text" id="classe" placeholder="Classe">
                </div>
                
                <button onclick="ajouterEleve()">+ Ajouter cet √©l√®ve</button>
                
                <div class="student-list">
                    <h3>√âl√®ves ajout√©s</h3>
                    <div id="liste-eleves">
                        <!-- Les √©l√®ves seront ajout√©s ici dynamiquement -->
                    </div>
                </div>
            </div>

            <div class="card no-print">
                <h2>Paiement</h2>
                <div class="form-group">
                    <label for="montant-total">Montant total √† payer</label>
                    <input type="text" id="montant-total" readonly value="0 FCFA">
                </div>
                
                <div class="form-group">
                    <label for="montant-verse">Montant vers√© (FCFA) *</label>
                    <input type="number" id="montant-verse" min="0" onchange="calculerReste()">
                </div>
                
                <div class="form-group">
                    <label for="reste-payer">Reste √† payer (FCFA)</label>
                    <input type="text" id="reste-payer" readonly value="0 FCFA">
                </div>
                
                <div class="form-group">
                    <label for="observations">Observations</label>
                    <textarea id="observations" rows="2" placeholder="Notes √©ventuelles"></textarea>
                </div>
                
                <div class="actions">
                    <button onclick="enregistrerPaiement()">Enregistrer le paiement</button>
                    <button class="sms" onclick="envoyerSMS()">üì± Envoyer SMS r√©capitulatif</button>
                    <button class="secondary" onclick="afficherRecap()">Afficher le r√©capitulatif</button>
                    <button class="print" onclick="imprimerHistorique()">üñ®Ô∏è Imprimer Historique</button>
                    <button class="secondary" onclick="genererRecapGlobal()">üìä R√©cap Global</button>
                </div>
            </div>

            <!-- Section pour afficher les derniers paiements -->
            <div class="card no-print">
                <h2>Derniers paiements enregistr√©s</h2>
                <div id="derniers-paiements" class="derniers-paiements">
                    <!-- Les derniers paiements seront affich√©s ici -->
                </div>
                <div class="voir-plus">
                    <button class="secondary" onclick="showTab('historique')">Voir tous les paiements</button>
                </div>
            </div>
        </div>

        <!-- Onglet Impact sur le Budget -->
        <div id="budget" class="tab-content">
            <div class="recap-header">
                <h2>Impact des Cotisations sur le Budget Pr√©visionnel</h2>
                <p>√âtat des recettes provenant des cotisations des parents</p>
            </div>
            
            <div class="budget-stats">
                <div class="stat-box">
                    <h3>Objectif de Recettes</h3>
                    <div class="stat-value" id="objectif-recettes">1 250 000 FCFA</div>
                    <p>Cotisations attendues (100 √©l√®ves √ó 12 500 FCFA)</p>
                </div>
                
                <div class="stat-box">
                    <h3>Recettes R√©alis√©es</h3>
                    <div class="stat-value" id="recettes-realisees">0 FCFA</div>
                    <p>Total des cotisations per√ßues</p>
                </div>
                
                <div class="stat-box">
                    <h3>Taux de R√©alisation</h3>
                    <div class="stat-value" id="taux-realisation">0%</div>
                    <p>Pourcentage de l'objectif atteint</p>
                </div>
            </div>
            
            <div class="progress-container">
                <h3>Progression vers l'objectif</h3>
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-bar-fill" style="width: 0%"></div>
                </div>
                <div class="progress-text" id="progress-text">0%</div>
            </div>
            
            <div class="budget-impact">
                <h3>D√©tail des cotisations par mois</h3>
                <table>
                    <thead>
                        <tr>
                            <th>Mois</th>
                            <th>Nombre de paiements</th>
                            <th>Montant per√ßu</th>
                            <th>√âl√®ves concern√©s</th>
                        </tr>
                    </thead>
                    <tbody id="details-mensuels">
                        <!-- Les d√©tails mensuels seront ajout√©s ici dynamiquement -->
                    </tbody>
                </table>
            </div>
            
            <div class="recap-actions">
                <button onclick="imprimerRapportBudget()">Imprimer le rapport budget</button>
                <button class="secondary" onclick="exporterRapportBudget()">Exporter les donn√©es budget</button>
            </div>
        </div>

        <!-- Onglet Historique des Paiements -->
        <div id="historique" class="tab-content">
            <h2>Historique des paiements</h2>
            <table id="tableau-paiements">
                <thead>
                    <tr>
                        <th>Parent/Tuteur</th>
                        <th>T√©l√©phone</th>
                        <th>√âl√®ve(s)</th>
                        <th>Classe(s)</th>
                        <th>Montant vers√©</th>
                        <th>Reste √† payer</th>
                        <th>Date</th>
                        <th class="no-print">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Les paiements seront ajout√©s ici dynamiquement -->
                </tbody>
            </table>
            
            <div class="no-print recap-actions">
                <button onclick="genererRecapGlobal()">G√©n√©rer un r√©capitulatif global</button>
                <button onclick="exporterDonnees()">Exporter toutes les donn√©es</button>
            </div>
            
            <div id="recap-global" class="recap-container">
                <div class="recap-header">
                    <h2>R√©capitulatif Global des Paiements</h2>
                    <p>Date de g√©n√©ration: <span id="date-recap"></span></p>
                </div>
                <div id="contenu-recap"></div>
                <div class="recap-actions">
                    <button onclick="imprimerRecap()">Imprimer ce r√©capitulatif</button>
                    <button onclick="fermerRecap()">Fermer</button>
                </div>
            </div>
        </div>

        <div class="signature no-print">
            <div>Le Caissier</div>
            <div>Le Tr√©sorier</div>
        </div>
        
        <div id="instructions" class="no-print">
            <b>Instructions d'utilisation</b>
            <ul>
                <li>1. Renseignez les informations du parent (nom, t√©l√©phone, adresse)</li>
                <li>2. Ajoutez un ou plusieurs √©l√®ves avec le bouton "Ajouter cet √©l√®ve"</li>
                <li>3. Le montant total est calcul√© automatiquement</li>
                <li>4. Saisissez le montant vers√©, le reste √† payer se calcule automatiquement</li>
                <li>5. Cliquez sur "Enregistrer le paiement" pour sauvegarder</li>
                <li>6. Utilisez le bouton "Envoyer SMS" pour envoyer un r√©capitulatif au parent</li>
                <li>7. Utilisez "Imprimer Historique" pour imprimer uniquement le tableau des paiements</li>
                <li>8. Utilisez "R√©cap Global" pour g√©n√©rer un rapport de tous les parents</li>
                <li>9. Consultez l'onglet "Impact sur le Budget" pour voir l'√©tat des recettes</li>
                <li>10. Utilisez le bouton üóëÔ∏è pour supprimer un paiement ind√©sirable</li>
                <li>11. Consultez la section "Derniers paiements" pour voir les enregistrements r√©cents</li>
                <li>12. <strong>Nouveau</strong> : Cette application peut √™tre install√©e sur votre appareil</li>
            </ul>
        </div>
    </div>

    <script src="script.js"></script>
    
    <!-- Script PWA -->
      <script> 
        // Enregistrement du Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('./sw.js')
                    .then(function(registration) {
                        console.log('Service Worker enregistr√© avec succ√®s:', registration);
                    })
                    .catch(function(error) {
                        console.log("√âchec de l'enregistrement du Service Worker:", error);
                    });
            });
        }

        // Gestion de l'installation de l'application
        let deferredPrompt;
        const installButton = document.getElementById('install-button');
        const pwaStatus = document.getElementById('pwa-status');
        const pwaMessage = document.getElementById('pwa-message');

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            // Afficher le bouton d'installation
            pwaStatus.style.display = 'block';
            pwaMessage.textContent = 'Cette application peut √™tre install√©e sur votre appareil';
            installButton.style.display = 'inline-block';
            
            installButton.addEventListener('click', () => {
                installButton.style.display = 'none';
                pwaMessage.textContent = 'Installation en cours...';
                
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        pwaMessage.textContent = 'Application install√©e avec succ√®s!';
                    } else {
                        pwaMessage.textContent = 'Installation annul√©e';
                    }
                    deferredPrompt = null;
                    
                    setTimeout(() => {
                        pwaStatus.style.display = 'none';
                    }, 3000);
                });
            });
        });

        // V√©rifier si l'application est d√©j√† install√©e
        window.addEventListener('appinstalled', (evt) => {
            console.log('Application install√©e avec succ√®s');
        });

        // V√©rifier le mode d'affichage
        if (window.matchMedia('(display-mode: standalone)').matches) {
            console.log('Application en mode standalone');
        }
    </script>
</body>
</html>
